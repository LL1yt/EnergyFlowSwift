"""
–ú–æ–¥—É–ª—å Spatial Hashing –¥–ª—è 3D –†–µ—à–µ—Ç–∫–∏
======================================

–†–µ–∞–ª–∏–∑—É–µ—Ç –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
–ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π –≤ —Ç—Ä–µ—Ö–º–µ—Ä–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ. –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º
–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º –¥–ª—è –Ω–æ–≤–æ–π, –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–≤—è–∑–Ω–æ—Å—Ç–∏.

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- MortonEncoder: –†–µ–∞–ª–∏–∑—É–µ—Ç –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫—Ä–∏–≤–æ–π –ú–æ—Ä—Ç–æ–Ω–∞ (Z-order curve)
                 –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è 3D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ 1D –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
                 –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à–∞.
- SpatialHashGrid: –†–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—É—é –∏ –±—ã—Å—Ç—Ä—É—é –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—É—é —Ö—ç—à-—Ä–µ—à–µ—Ç–∫—É,
                   –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–æ—Å–µ–¥–µ–π –≤ —Ä–∞–¥–∏—É—Å–µ –∑–∞ –≤—Ä–µ–º—è O(1)
                   –≤ —Å—Ä–µ–¥–Ω–µ–º —Å–ª—É—á–∞–µ.

–ê–≤—Ç–æ—Ä: 3D Cellular Neural Network Project
–í–µ—Ä—Å–∏—è: 1.0.0 (2024-07-15)
"""

import numpy as np
from typing import Tuple, List, Dict, Set

Coordinates3D = Tuple[int, int, int]


class MortonEncoder:
    """
    ‚ö†Ô∏è PARTIALLY DEPRECATED: –ö–æ–¥–∏—Ä–æ–≤—â–∏–∫ –∫—Ä–∏–≤–æ–π –ú–æ—Ä—Ç–æ–Ω–∞ –¥–ª—è 3D-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.
    ========================================================================

    üö® –ß–ê–°–¢–ò–ß–ù–û –£–°–¢–ê–†–ï–õ: –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ GPUMortonEncoder!

    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç 3D-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –æ–¥–Ω–æ–º–µ—Ä–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, —Å–æ—Ö—Ä–∞–Ω—è—è
    –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –±–ª–∏–∑–æ—Å—Ç—å. –ö–ª–µ—Ç–∫–∏, –±–ª–∏–∑–∫–∏–µ –≤ 3D, —Å –≤—ã—Å–æ–∫–æ–π
    –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –±—É–¥—É—Ç –±–ª–∏–∑–∫–∏ –∏ –≤ 1D-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏.

    –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ó–ê–ú–ï–ù–ê:
    - new_rebuild.core.lattice.gpu_spatial_hashing.GPUMortonEncoder
    –ü–†–ò–ß–ò–ù–ê: GPU acceleration, batch processing, better performance

    –ö–ª–∞—Å—Å –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤.
    """

    def __init__(self, dimensions: Coordinates3D):
        self.max_dim = max(dimensions)
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏—Ç, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        self.bits = self.max_dim.bit_length()

    def _interleave_bits(self, x: int, y: int, z: int) -> int:
        """–í—Å—Ç–∞–≤–ª—è–µ—Ç –±–∏—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Z-order –∫–æ–¥–∞."""
        code = 0
        for i in range(self.bits):
            # –ò–∑–≤–ª–µ–∫–∞–µ–º i-–π –±–∏—Ç –∏–∑ –∫–∞–∂–¥–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            x_bit = (x >> i) & 1
            y_bit = (y >> i) & 1
            z_bit = (z >> i) & 1

            # –†–∞–∑–º–µ—â–∞–µ–º –±–∏—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö: x, y, z —á–µ—Ä–µ–¥—É—é—Ç—Å—è
            code |= (z_bit << (3 * i)) | (y_bit << (3 * i + 1)) | (x_bit << (3 * i + 2))
        return code

    def encode(self, coords: Coordinates3D) -> int:
        """–ö–æ–¥–∏—Ä—É–µ—Ç 3D-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ 1D-–∫–æ–¥ –ú–æ—Ä—Ç–æ–Ω–∞."""
        x, y, z = coords
        return self._interleave_bits(x, y, z)

    def decode(self, code: int) -> Coordinates3D:
        """–î–µ–∫–æ–¥–∏—Ä—É–µ—Ç 1D-–∫–æ–¥ –ú–æ—Ä—Ç–æ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ 3D-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã."""
        x = self._deinterleave_bits(code, 2)
        y = self._deinterleave_bits(code, 1)
        z = self._deinterleave_bits(code, 0)
        return x, y, z

    def _deinterleave_bits(self, code: int, offset: int) -> int:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∏—Ç—ã –æ–¥–Ω–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –∫–æ–¥–∞ –ú–æ—Ä—Ç–æ–Ω–∞."""
        val = 0
        for i in range(self.bits):
            val |= ((code >> (3 * i + offset)) & 1) << i
        return val


class SpatialHashGrid:
    """
    ‚ö†Ô∏è DEPRECATED: –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ö—ç—à-—Ä–µ—à–µ—Ç–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π.
    =============================================================================

    üö® –£–°–¢–ê–†–ï–õ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GPUSpatialHashGrid –∏–ª–∏ AdaptiveGPUSpatialHash!

    –†–∞–∑–¥–µ–ª—è–µ—Ç 3D-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –Ω–∞ —Å–µ—Ç–∫—É —è—á–µ–µ–∫ –∏ —Ö—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–∫–∏ –∫–ª–µ—Ç–æ–∫
    –≤ –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–µ. –ü–æ–∏—Å–∫ —Å–æ—Å–µ–¥–µ–π —Å–≤–æ–¥–∏—Ç—Å—è –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –ª–∏—à—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö
    —Å–º–µ–∂–Ω—ã—Ö —è—á–µ–µ–∫, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–±–æ—Ä–∞.

    –ó–ê–ú–ï–ù–ï–ù –ù–ê:
    - new_rebuild.core.lattice.gpu_spatial_hashing.GPUSpatialHashGrid
    - new_rebuild.core.lattice.gpu_spatial_hashing.AdaptiveGPUSpatialHash
    –ü–†–ò–ß–ò–ù–ê: GPU acceleration, batch processing, memory optimization

    DEPRECATED —Å 28 –¥–µ–∫–∞–±—Ä—è 2025. –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –≤ –≤–µ—Ä—Å–∏–∏ 2.0.
    """

    def __init__(self, dimensions: Coordinates3D, cell_size: int):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—ç—à-—Ä–µ—à–µ—Ç–∫–∏.

        Args:
            dimensions: –†–∞–∑–º–µ—Ä—ã –≤—Å–µ–π 3D-—Ä–µ—à–µ—Ç–∫–∏ (X, Y, Z).
            cell_size: –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏ —Ö—ç—à-—Ä–µ—à–µ—Ç–∫–∏. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å
                       –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–µ–Ω —Ä–∞–¥–∏—É—Å—É –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π.
        """
        if cell_size <= 0:
            raise ValueError("cell_size –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        self.dimensions = dimensions
        self.cell_size = cell_size

        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ö—ç—à-—Ä–µ—à–µ—Ç–∫–∏ –≤ —è—á–µ–π–∫–∞—Ö
        self.grid_dims = (
            (dimensions[0] + cell_size - 1) // cell_size,
            (dimensions[1] + cell_size - 1) // cell_size,
            (dimensions[2] + cell_size - 1) // cell_size,
        )

        # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: —Å–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á - —Ö—ç—à —è—á–µ–π–∫–∏,
        # –∞ –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–ø–∏—Å–æ–∫ –ª–∏–Ω–µ–π–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∫–ª–µ—Ç–æ–∫ –≤ –Ω–µ–π.
        self.grid: Dict[int, List[int]] = {}

    def _get_grid_coords(self, coords: Coordinates3D) -> Coordinates3D:
        """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏ —Ö—ç—à-—Ä–µ—à–µ—Ç–∫–∏."""
        return (
            coords[0] // self.cell_size,
            coords[1] // self.cell_size,
            coords[2] // self.cell_size,
        )

    def _hash(self, grid_coords: Coordinates3D) -> int:
        """–í—ã—á–∏—Å–ª—è–µ—Ç —Ö—ç—à –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —è—á–µ–π–∫–∏ (–ø—Ä–æ—Å—Ç–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ç–µ–∂–∞)."""
        return hash(grid_coords)

    def insert(self, coords: Coordinates3D, cell_linear_index: int):
        """
        –í—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–µ—Ç–∫—É –≤ —Ä–µ—à–µ—Ç–∫—É.

        Args:
            coords: –ú–∏—Ä–æ–≤—ã–µ 3D-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–µ—Ç–∫–∏.
            cell_linear_index: –õ–∏–Ω–µ–π–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∫–ª–µ—Ç–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.
        """
        grid_coords = self._get_grid_coords(coords)
        key = self._hash(grid_coords)

        if key not in self.grid:
            self.grid[key] = []
        self.grid[key].append(cell_linear_index)

    def query_radius(self, coords: Coordinates3D, radius: float) -> List[int]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö —Å–æ—Å–µ–¥–µ–π –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Ä–∞–¥–∏—É—Å–µ –æ—Ç —Ç–æ—á–∫–∏.

        Args:
            coords: 3D-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏.
            radius: –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞.

        Returns:
            –°–ø–∏—Å–æ–∫ –ª–∏–Ω–µ–π–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫-—Å–æ—Å–µ–¥–µ–π.
        """
        center_grid_coords = self._get_grid_coords(coords)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥—Ä–∞–Ω–∏—Ü
        min_x = max(0, (coords[0] - int(radius)) // self.cell_size)
        max_x = min(self.grid_dims[0] - 1, (coords[0] + int(radius)) // self.cell_size)
        min_y = max(0, (coords[1] - int(radius)) // self.cell_size)
        max_y = min(self.grid_dims[1] - 1, (coords[1] + int(radius)) // self.cell_size)
        min_z = max(0, (coords[2] - int(radius)) // self.cell_size)
        max_z = min(self.grid_dims[2] - 1, (coords[2] + int(radius)) // self.cell_size)

        found_indices: Set[int] = set()

        # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —è—á–µ–π–∫–∏
        for gx in range(min_x, max_x + 1):
            for gy in range(min_y, max_y + 1):
                for gz in range(min_z, max_z + 1):
                    key = self._hash((gx, gy, gz))
                    if key in self.grid:
                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º set.update –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                        # —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
                        found_indices.update(self.grid[key])

        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ—Ç –ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏–∑
        # —Å–º–µ–∂–Ω—ã—Ö —è—á–µ–µ–∫. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª—Å—è –±—ã
        # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–æ—á–Ω–æ–º—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é,
        # –Ω–æ –¥–ª—è –Ω–∞—à–∏—Ö —Ü–µ–ª–µ–π "–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–µ–≥–æ" –ø–æ–∏—Å–∫–∞ —ç—Ç–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ.

        # –£–¥–∞–ª—è–µ–º —Å–∞–º—É —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –∫–ª–µ—Ç–∫—É –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ —Ç–∞–º –æ–∫–∞–∑–∞–ª–∞—Å—å
        # (–≤ –¥–∞–Ω–Ω–æ–º –º–µ—Ç–æ–¥–µ –º—ã –Ω–µ –∑–Ω–∞–µ–º –µ–µ –∏–Ω–¥–µ–∫—Å, —ç—Ç–æ –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥)
        return list(found_indices)
