# Energy Flow Improvement Report

Дата: 2025-08-08  
Область: `energy_flow/` (ядро: lattice / carrier / neuron / flow_processor)  
Принципы (CLAUDE.md): модульность, отсутствие fallback, максимум GPU, простые высокоимпактные шаги.

---

## 1. Критические ошибки (нужно исправить немедленно)

| №   | Проблема                                                                                                                      | Файл                                                     | Суть                                                                    | Быстрый фикс                                                                         | Импакт                        |
| --- | ----------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------------------------------ | ----------------------------- |
| 1   | Синтаксические пустые блоки `if` / `for`                                                                                      | `flow_processor.py`                                      | Множество конструкций без тела → код не исполняем                       | Поставить `pass` или реализовать логику                                              | Ломает модуль полностью       |
| 2   | Отсутствуют импорты (`torch`, `nn`, `time`, `numpy as np`)                                                                    | `flow_processor.py`                                      | Используются без импорта                                                | Добавить импорты в начале                                                            | Код не запускается            |
| 3   | Функции возвращают `None` вместо объявленных значений                                                                         | `_collect_final_output`, `_collect_final_surface_output` | Несоответствие сигнатуре → ошибки использования                         | Вернуть корректные кортежи даже если пусто                                           | Runtime ошибки                |
| 4   | Дублирующееся объявление `update_flow` (две версии)                                                                           | `energy_lattice.py`                                      | Переопределение, путаница семантики                                     | Переименовать вторую или удалить первую неактуальную                                 | Скрытые баги поведения        |
| 5   | Потенциально некорректная логика завершения: в `update_flow` (первая версия) вызывает `_buffer_flow_to_*`, которых больше нет | `energy_lattice.py`                                      | Ссылки на удалённые методы (комментарий намекает)                       | Удалить устаревшую версию метода                                                     | Предотвратить AttributeError  |
| 6   | Неверное восстановление размерности в `collect_completed_flows_direct`                                                        | `energy_lattice.py`                                      | Склеивание и обрезание до 768 без сопоставления поверхности             | Заменить на агрегирование по батчу / surface и затем mapper обратного преобразования | Искажение данных              |
| 7   | Потенциально взрывная сложность `round_to_nearest_lattice_position`                                                           | `energy_lattice.py`                                      | O(batch * (W*H\*(D+1))) память/время (невыполнимо при больших решётках) | Заменить на прямое квантование индекса (арифметика)                                  | Производительность / OOM      |
| 8   | Двойное определение `_cleanup_inactive_flows`                                                                                 | `energy_lattice.py`                                      | Дубликат кода                                                           | Оставить одну версию                                                                 | Чистота кода                  |
| 9   | Использование `torch.round` поверх нормализованных координат в `_compute_next_position_relative`                              | `energy_carrier.py`                                      | Потеря мелких смещений, залипание                                       | Округлять только после денормализации или вообще убрать                              | Деградация обучения           |
| 10  | Неполные ветки логики (конвергенция, spawn, reflection)                                                                       | `flow_processor.py`                                      | Блоки без реализации → статистика пустая                                | Реализовать минимальные версии                                                       | Неверная адаптивная остановка |

---

## 2. Высокоимпактные простые оптимизации (быстрые выигрыши)

| №   | Оптимизация                                                               | Деталь                                                                   | Оценка выигрыша                                         |
| --- | ------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------- |
| 1   | Заменить поиск ближайшей lattice позиции на арифметическое квантование    | Из нормализованных координат => индекс = round((x+1)/2\*(W-1)) и обратно | Сильное ускорение, <1% времени вместо O(N\*M)           |
| 2   | Предкешировать нормализованные z плоскости                                | `norm_z0`, `norm_zdepth` вычисляются многократно                         | Микровыигрыш, но упрощает код                           |
| 3   | Векторизовать весовые коэффициенты при агрегации                          | Сейчас Python цикл по flows_in_cell                                      | Уменьшение накладных расходов при множественных потоках |
| 4   | Удалить избыточные `.clone()` в `batch_update_flows`                      | Уже отделены от графа                                                    | Экономия памяти/копий                                   |
| 5   | Lazy-логирование через `if logger.isEnabledFor` вокруг тяжёлых вычислений | Некоторые debug секции всегда считают статистику                         | Снижение стоимости debug режима                         |
| 6   | Пакетное вычисление distance_to_surface при создании spawn                | Можно использовать векторный расчёт                                      | Ускорение spawn фаз                                     |
| 7   | Отложенная очистка завершённых потоков батчами                            | Сейчас удаление в нескольких местах                                      | Снижение фрагментации словаря                           |
| 8   | Использовать `torch.cuda.reset_peak_memory_stats()` после очисток         | Для точной телеметрии                                                    | Более корректный мониторинг                             |

---

## 3. Улучшения корректности / обучения

| Категория       | Предложение                                                        | Обоснование                                                 |
| --------------- | ------------------------------------------------------------------ | ----------------------------------------------------------- |
| Координаты      | Отказ от `torch.round` в нормализованном пространстве              | Сохраняет плавность градиентов направления                  |
| Завершение      | Вынести логику termination полностью из Carrier в Processor        | Carrier только прогнозирует смещения; архитектурная чистота |
| Агрегация       | Корректное сопоставление surface→embedding (нужен обратный mapper) | Сейчас искажение эмбеддингов                                |
| Spawn           | Явная метрика (например displacement_norm percentile > threshold)  | Более контролируемые разветвления                           |
| Конвергенция    | Хранить скользящее окно вместо общего счётчика                     | Стабильность адаптивной остановки                           |
| Весовая система | Нормировать importance по softmax вместо ручного деления           | Избегание крайних весов                                     |
| Distance cache  | Кешировать `distance_to_surface` при каждом обновлении позиции     | Меньше повторных расчётов                                   |

---

## 4. Архитектурные предложения (средняя сложность)

| Тема                  | Идея                                                                     | Выгода                                      |
| --------------------- | ------------------------------------------------------------------------ | ------------------------------------------- |
| Tensorized Flow State | Хранить позиции/энергии/hidden в единых тензорах + индексы активных      | Устранение Python overhead при 10k+ потоках |
| Event Tracing         | Лёгкий кольцевой буфер событий (spawn, reflect, terminate)               | Пост‑анализ без избыточного логгинга        |
| Deterministic Mode    | Флаг фиксирующий seed и отключающий шум                                  | Воспроизводимость экспериментов             |
| Config Guard          | Автоматическая валидация связок параметров (например spawn + reflection) | Ранний fail с понятным сообщением           |

---

## 5. Логирование и диагностика

| Проблема                                                | Исправление                                 |
| ------------------------------------------------------- | ------------------------------------------- | -------------------------- |
| Пересекающиеся уровни (`debug_forward`, `debug_energy`) | Таблица соответствия уровней → единообразие |
| Нет компактного свода по завершении                     | Добавить `summarize_step(step_metrics)`     | Быстрый анализ без скролла |

---

| Риск                                                     | Митигирование                                  |
| -------------------------------------------------------- | ---------------------------------------------- | ------------ |
| Удаление округления вызывает дрейф за границы            | Жёсткий clamp после каждого шага               |
| Tensorized хранилище усложнит spawn                      | Сначала оставить гибрид: tensor + список новых |
| Изменение агрегации изменит распределение обучающей цели | Ввести флаг `aggregation_mode=legacy           | weighted_v2` |

---
