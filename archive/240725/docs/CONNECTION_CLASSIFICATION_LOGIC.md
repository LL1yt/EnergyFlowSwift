# Логика классификации связей - Улучшенная схема

## Проблема

Ранее у нас было только 2 порога расстояния:

- `local_distance_threshold` (1.5)
- `distant_distance_threshold` (4.5)

И между ними был большой промежуток (1.5 - 4.5), где все связи считались потенциально функциональными.

## Решение: Добавлен `functional_distance_threshold`

Теперь у нас **4 порога** для более точной классификации:

### Пороги расстояния:

1. **`local_distance_threshold`** = 1.5 - порог для местных связей
2. **`functional_distance_threshold`** = 3.0 - максимальное расстояние для функциональных
3. **`distant_distance_threshold`** = 4.5 - порог для дальних связей

### Порог функциональной близости:

4. **`functional_similarity_threshold`** = 0.3 - порог косинусного сходства состояний

## Новая логика классификации

```
Расстояние (distance):

0 ────── 1.5 ────── 3.0 ────── 4.5 ────── ∞
│        │          │          │         │
│  LOCAL │  FUNC-1  │  FUNC-2  │ DISTANT │
│        │          │          │         │
```

### Правила:

1. **LOCAL** `(distance ≤ 1.5)`

   - Ближайшие соседи → **LOCAL Expert**
   - Рефлексы, простые связи

2. **FUNCTIONAL-1** `(1.5 < distance ≤ 3.0)`

   - Умеренно близкие → **FUNCTIONAL Expert**
   - Автоматически функциональные (хорошее расстояние)

3. **FUNCTIONAL-2** `(3.0 < distance < 4.5)`

   - Проверяем `functional_similarity ≥ 0.3`
   - Если **да** → **FUNCTIONAL Expert**
   - Если **нет** → **DISTANT Expert**

4. **DISTANT** `(distance ≥ 4.5)`
   - Дальние связи → **DISTANT Expert**
   - Долгосрочная память, CNF

## Преимущества

### ✅ Более точная классификация

- Четкое разделение функциональных связей на 2 подтипа
- Автоматические функциональные (близкие) vs проверяемые (средние)

### ✅ Биологическая правдоподобность

- Ближние связи (дендриты) → рефлексы
- Средние связи (локальные сети) → функциональная обработка
- Дальние связи (межрегиональные) → долгосрочная память

### ✅ Лучший контроль пропорций

- Можем настраивать 10%/55%/35% распределение точнее
- Меньше ложных функциональных связей

## Пример классификации

Для решетки 5×5×5 (125 клеток):

```python
# Клетка в центре (62) и её соседи:
neighbors = [37, 61, 63, 87]  # примерные индексы

distances = [
    1.0,  # → LOCAL (близкий сосед)
    2.5,  # → FUNCTIONAL-1 (автоматически функциональный)
    3.8,  # → FUNCTIONAL-2 или DISTANT (проверяем similarity)
    5.2   # → DISTANT (дальний)
]
```

## Learnable пороги

Все пороги являются `nn.Parameter`, то есть могут обучаться:

- `local_distance_threshold` - может уменьшаться/увеличиваться
- `functional_distance_threshold` - может адаптироваться
- `distant_distance_threshold` - может корректироваться
- `functional_similarity_threshold` - может настраиваться

Это позволяет сети самостоятельно находить оптимальные границы классификации в процессе обучения.

---

**Результат**: Более биологически правдоподобная и контролируемая классификация связей.
