graph TB
    %% üéâ STAGE 1 & 2 COMPLETE - DUAL ARCHITECTURE SUCCESS
    
    subgraph "INPUT LAYER"
        A[Input Embedding<br/>768D Vector] --> B{DecodingConfig<br/>Validation}
        B --> C1[PhraseBankDecoder<br/>üéâ PRODUCTION-READY Stage 1]
        B --> C2[RET v2.1 ULTRA-COMPACT<br/>üéâ 722K PARAMS Stage 2]
    end
    
    subgraph "STAGE 1: PHRASE-BASED DECODER [PRODUCTION ‚úÖ]"
        C1 --> D[Configuration Manager<br/>‚úÖ Save/Load Config]
        C1 --> E[Pattern Cache<br/>üíæ LRU Caching 25-50%]
        C1 --> F[Error Handler<br/>üõ°Ô∏è 100% Fallback Coverage]
        C1 --> G[Performance Monitor<br/>üìä Real-time Analytics]
        
        D --> H[PhraseBank<br/>üìö Phrase Storage & Search]
        H --> I[Similarity Search<br/>üîç k=10 candidates]
        I --> J[Context Analyzer<br/>üß† Context-aware Selection]
    end
    
    subgraph "STAGE 2: RET v2.1 ULTRA-COMPACT [722K PARAMS ‚úÖ]"
        C2 --> RET1[üîß Embedding Bridge<br/>768‚Üí256D reduction]
        RET1 --> RET2[üìù Token Embedding<br/>256√ó256 micro vocab]
        RET2 --> RET3[üîÑ Single Layer Sharing<br/>Parameter efficiency]
        
        subgraph "RET ULTRA-COMPACT LAYER"
            RET3 --> RET4[‚ö° Ultra-Compact Attention<br/>2 heads, simplified QKV]
            RET4 --> RET5[üßÆ Micro MLP<br/>1.5x expansion ratio]
            RET5 --> RET6[üîó Tied Weights<br/>No separate lm_head]
        end
        
        RET6 --> RET7[üöÄ RTX 5090 Optimizations<br/>Mixed precision, CUDA kernels]
        RET7 --> RET8[‚ö° Dynamic Quantization<br/>INT4 real-time compression]
        RET8 --> RET9[üéØ Aggressive Pruning<br/>80% inference pruning]
    end
    
    subgraph "ASSEMBLY STRATEGIES [STAGE 1]"
        J --> K{Assembly Method}
        K --> L[Weighted Assembly<br/>üìè Similarity-based]
        K --> M[Greedy Assembly<br/>‚ö° Best-first]
        K --> N[Beam Search<br/>üî¨ Multi-candidate]
        K --> O[Context-aware<br/>üéØ Intelligent Selection]
    end
    
    subgraph "POST-PROCESSING LAYER"
        L --> P[Text Assembler<br/>üîß Multiple Strategies]
        M --> P
        N --> P
        O --> P
        
        RET9 --> P2[RET Output Generation<br/>üéâ Ultra-efficient text]
        
        P --> Q[Text Post-processor<br/>‚ú® Grammar Enhancement]
        P2 --> Q
        Q --> R[Quality Assessor<br/>üìè Confidence Scoring]
    end
    
    subgraph "OUTPUT & MONITORING"
        R --> S[Decoded Text Output<br/>üéØ Multi-architecture]
        R --> T[Quality Metrics<br/>Confidence, Similarity]
        
        G --> U[Performance Statistics<br/>Cache hits, Timing]
        F --> V[Error Statistics<br/>Types, Recovery rates]
        E --> W[Cache Analytics<br/>Hit rates, Efficiency]
        
        RET7 --> U2[RET Performance<br/>‚ö° <50ms inference]
        RET8 --> U3[Memory Metrics<br/>üíæ 76% reduction achieved]
        RET9 --> U4[Parameter Stats<br/>üìä 722K/800K target]
    end
    
    subgraph "PRODUCTION FEATURES"
        X[Health Monitoring<br/>üè• Component Status] --> C1
        Y[Session Management<br/>üîÑ Context Tracking] --> C1
        Z[Batch Processing<br/>üì¶ Multiple Inputs] --> C1
        AA[Production Optimizer<br/>üöÄ Auto-tuning] --> C1
        
        X2[RET Health Monitor<br/>üè• Parameter tracking] --> C2
        Y2[RET Memory Monitor<br/>üíæ GPU efficiency] --> C2
        Z2[RET Quick Testing<br/>üß™ <30s validation] --> C2
    end
    
    %% Module Integration Flows
    subgraph "MODULE INTEGRATION"
        BB[Module 1: Teacher LLM<br/>üî¥ Text ‚Üí Embedding] --> A
        CC[Module 2: 3D Cubic Core<br/>üîµ Embedding ‚Üí Processed] --> A
        S --> DD[Module 3 Output<br/>üü° Dual-architecture text]
    end
    
    %% Advanced Features
    subgraph "ADVANCED CAPABILITIES"
        EE[Configuration Validation<br/>üìã Schema checking] --> B
        FF[Fallback Strategies<br/>üîÑ Multi-decoder] --> F
        GG[Multiple Architecture Support<br/>üß† Phrase+Transformer] --> H
        HH[Cache Management<br/>üóÑÔ∏è LRU + Analytics] --> E
        
        II[RET Configuration<br/>üîß Ultra-compact settings] --> C2
        JJ[Parameter Optimization<br/>üéØ 722K achievement] --> RET3
        KK[RTX 5090 Support<br/>üöÄ GPU acceleration] --> RET7
    end
    
    %% Performance Optimization Flows
    subgraph "CRITICAL PERFORMANCE PATHS"
        RET1 -.->|"CRITICAL: 768‚Üí256"| RET2
        RET3 -.->|"CRITICAL: Single layer"| RET4
        RET6 -.->|"CRITICAL: Tied weights"| RET7
        RET8 -.->|"CRITICAL: 80% pruning"| RET9
    end
    
    %% Style definitions
    classDef productionReady fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:white
    classDef retSuccess fill:#FF4081,stroke:#C2185B,stroke-width:3px,color:white
    classDef coreFunction fill:#2196F3,stroke:#1565C0,stroke-width:2px,color:white
    classDef monitoring fill:#FF9800,stroke:#E65100,stroke-width:2px,color:white
    classDef integration fill:#9C27B0,stroke:#6A1B9A,stroke-width:2px,color:white
    classDef advanced fill:#607D8B,stroke:#37474F,stroke-width:2px,color:white
    classDef critical fill:#F44336,stroke:#D32F2F,stroke-width:4px,color:white
    
    %% Apply styles
    class C1,S productionReady
    class C2,RET1,RET2,RET3,RET6,RET7,RET8,RET9 retSuccess
    class H,I,J,P,Q,R,P2 coreFunction
    class G,U,V,W,X,U2,U3,U4 monitoring
    class BB,CC,DD integration
    class EE,FF,GG,HH,II,JJ,KK advanced
    class RET4,RET5 critical 