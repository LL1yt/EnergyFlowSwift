# –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏: –û—Ç–ª–∞–¥–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Spatial API

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å —Å–µ—Å—Å–∏–∏
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–∏—Å–∫–æ–º —Å–æ—Å–µ–¥–µ–π –≤ 3D Cellular Neural Network –∏ –æ—Ç–ª–∞–¥–∫–∞ spatial optimization —Å–∏—Å—Ç–µ–º—ã.

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ Spatial API

**–ü—Ä–æ–±–ª–µ–º–∞**: `'UnifiedSpatialOptimizer' object has no attribute 'find_neighbors'`

**–†–µ—à–µ–Ω–∏–µ**: 
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `find_neighbors()` –≤ `GPUSpatialProcessor` (`new_rebuild/core/lattice/spatial_optimization/gpu_spatial_processor.py`)
- –ú–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `adaptive_hash.query_radius_batch()` –¥–ª—è GPU-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤—Ö–æ–¥–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (tuple, list, tensor)

### ‚úÖ 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Spatial Hash

**–ü—Ä–æ–±–ª–µ–º–∞**: Spatial hash –±—ã–ª –ø—É—Å—Ç–æ–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ (0 —Å–æ—Å–µ–¥–µ–π)

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_ensure_spatial_hash_initialized()` —Å –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ hash –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ `find_neighbors()`
- –°–æ–∑–¥–∞–Ω–∏–µ dummy states –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫ —Ä–µ—à–µ—Ç–∫–∏

### ‚úÖ 3. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–ª–µ—Ç–∫–∞ –≤–∫–ª—é—á–∞–ª–∞—Å—å –≤ —Å–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö —Å–æ—Å–µ–¥–µ–π

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –∫–ª–µ—Ç–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `pos_helper.to_linear_index()` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

### ‚úÖ 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∞—Ç—Ä–∏–±—É—Ç `enable_adaptive_chunking` –≤ `UnifiedOptimizerSettings`

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω –∞—Ç—Ä–∏–±—É—Ç `enable_adaptive_chunking: bool = True` –≤ `config_components.py`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

### ‚úÖ 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º—ã**:
- `test_neighbor_finding.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `find_neighbors`
- `test_neighbor_analysis.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —É—Å—Ç–∞—Ä–µ–≤—à—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏—è**:
- –ó–∞–º–µ–Ω–µ–Ω–æ `find_neighbors` –Ω–∞ `find_neighbors_optimized` –≤ —Ç–µ—Å—Ç–∞—Ö
- –£–ø—Ä–æ—â–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `UnifiedSpatialOptimizer` –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π

### ‚úÖ 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Device Manager cleanup

**–ü—Ä–æ–±–ª–µ–º–∞**: Exception –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–∑-–∑–∞ –ø–æ–ø—ã—Ç–∫–∏ –æ—á–∏—Å—Ç–∏—Ç—å —É–∂–µ –æ—á–∏—â–µ–Ω–Ω—ã–π CUDA –∫—ç—à

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω—ã try-catch –±–ª–æ–∫–∏ –≤ –º–µ—Ç–æ–¥—ã `cleanup()`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ CUDA –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `empty_cache()`
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ

### ‚úÖ 7. –£—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ**: 
- –°–æ–∑–¥–∞–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è `test_minimal_forward.py` —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ forward pass'–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω –∞–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –≤–∞—Ä–∏–∞—Ü–∏–∏ loss'–æ–≤

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Spatial API Tests
```
‚úÖ test_spatial_api.py: 7 —Å–æ—Å–µ–¥–µ–π –¥–ª—è —É–≥–ª–æ–≤–æ–π –∫–ª–µ—Ç–∫–∏ [0,0,0]
‚úÖ test_neighbor_finding.py:
  - –£–≥–ª–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏: 7 —Å–æ—Å–µ–¥–µ–π
  - –ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∫–ª–µ—Ç–∫–∏: 15 —Å–æ—Å–µ–¥–µ–π  
  - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–ª–µ—Ç–∫–∏: 63 —Å–æ—Å–µ–¥–∞
  - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–ª–µ—Ç–∫–∞: 31 —Å–æ—Å–µ–¥
```

### Forward Pass Tests
```
‚úÖ test_minimal_forward.py: 
  - Forward pass –∑–∞ ~5.36 —Å–µ–∫—É–Ω–¥
  - –°—Ç–∞–±–∏–ª—å–Ω—ã–µ loss –∑–Ω–∞—á–µ–Ω–∏—è:
    * reconstruction: ~2.11
    * emergence: ~-0.07
    * spatial: ~0.07
    * total: ~2.10
```

## üîß –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. GPUSpatialProcessor (`gpu_spatial_processor.py`)
```python
def find_neighbors(self, coords, radius) -> List[int]:
    """–ü—Ä–æ—Å—Ç–æ–π API –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–µ–π –≤ —Ä–∞–¥–∏—É—Å–µ"""
    # –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è spatial hash
    self._ensure_spatial_hash_initialized()
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Ç–µ–Ω–∑–æ—Ä
    coords_tensor = self._convert_coords_to_tensor(coords)
    
    # –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ adaptive_hash
    neighbor_lists = self.adaptive_hash.query_radius_batch(coords_tensor, radius)
    
    # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
    return self._exclude_center_point(neighbor_lists, coords)
```

### 2. UnifiedOptimizerSettings (`config_components.py`)
```python
@dataclass
class UnifiedOptimizerSettings:
    enable_adaptive_chunking: bool = True  # –ù–æ–≤—ã–π –∞—Ç—Ä–∏–±—É—Ç
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

### 3. DeviceManager (`device_manager.py`)
```python
def cleanup(self):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏"""
    try:
        if hasattr(self, 'memory_monitor') and self.memory_monitor:
            self.memory_monitor.cleanup()
    except Exception:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        pass
```

## üéØ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

**‚úÖ Spatial API**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
**‚úÖ Neighbor Finding**: –ù–∞—Ö–æ–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Å–µ–¥–µ–π –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–ª–µ—Ç–æ–∫
**‚úÖ Forward Pass**: –°—Ç–∞–±–∏–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫  
**‚úÖ Memory Management**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
**‚úÖ Configuration**: –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–∏–º —ç—Ç–∞–ø–∞–º

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è:
1. **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö forward pass'–æ–≤** - –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è batch size** - memory management —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **–†–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è** - –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
4. **–û—Ç–ª–∞–¥–∫–∏ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤** - –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–ª–∞–∂–µ–Ω–∞

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö batch size** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å batch_size > 1
2. **Gradient computation** - —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ backward pass —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
3. **Memory optimization** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏
4. **Performance profiling** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–∫–∏—Ö –º–µ—Å—Ç –≤ pipeline

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- **GPU**: RTX 5090 32GB - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- **Lattice**: 8x8x8 (512 –∫–ª–µ—Ç–æ–∫) –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- **Embedding**: 768D ‚Üí 64D –ø—Ä–æ–µ–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **Spatial optimization**: GPU-—É—Å–∫–æ—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å–æ—Å–µ–¥–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- **Architecture**: UnifiedSpatialOptimizer + GPUSpatialProcessor + AdaptiveGPUSpatialHash

---
*–°–µ—Å—Å–∏—è –æ—Ç 30.06.2025 - –û—Ç–ª–∞–¥–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Spatial API –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ*